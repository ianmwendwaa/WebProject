<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - LoanPro</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full bg-gray-50">
    
    <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200">
   <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center py-4">
     <div class="flex items-center">
      <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center mr-3">
       <svg class="w-5 h-5 text-white" fill="currentColor" viewbox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" />
       </svg>
      </div>
      <h1 id="company-name" class="text-xl font-bold text-gray-900">LoanPro</h1>
     </div>
     <div class="flex items-center space-x-4"><span id="user-name" class="text-gray-700 font-medium">Welcome back!</span> <button id="logout-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors duration-200"> Sign Out </button>
     </div>
    </div>
   </div>
  </header>
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><!-- Welcome Section -->
   <div class="mb-8">
    <h2 id="welcome-message" class="text-3xl font-bold text-gray-900 mb-2">Welcome to your loan management dashboard</h2>
    <p class="text-gray-600">Track your loans, monitor payments, and stay on top of your financial goals.</p>
   </div><!-- Stats Overview -->
   <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
     <div class="flex items-center">
      <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
       <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
       </svg>
      </div>
      <div class="ml-4">
       <p class="text-sm font-medium text-gray-600">Total Loans</p>
       <p id="total-loans" class="text-2xl font-bold text-gray-900">0</p>
      </div>
     </div>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
     <div class="flex items-center">
      <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
       <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
       </svg>
      </div>
      <div class="ml-4">
       <p class="text-sm font-medium text-gray-600">Total Balance</p>
       <p id="total-balance" class="text-2xl font-bold text-gray-900">Ksh.0</p>
      </div>
     </div>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
     <div class="flex items-center">
      <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
       <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
       </svg>
      </div>
      <div class="ml-4">
       <p class="text-sm font-medium text-gray-600">Monthly Payment</p>
       <p id="monthly-payment" class="text-2xl font-bold text-gray-900">Ksh.0</p>
      </div>
     </div>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
     <div class="flex items-center">
      <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
       <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
       </svg>
      </div>
      <div class="ml-4">
       <p class="text-sm font-medium text-gray-600">Active Loans</p>
       <p id="active-loans" class="text-2xl font-bold text-gray-900">0</p>
      </div>
     </div>
    </div>
   </div><!-- Add New Loan Button -->
   <div class="mb-8"><button id="add-loan-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 shadow-lg hover:shadow-xl"> + Add New Loan </button>
   </div><!-- Loans List -->
   <div class="bg-white rounded-xl shadow-sm border border-gray-200">
    <div class="px-6 py-4 border-b border-gray-200">
     <h3 class="text-lg font-semibold text-gray-900">Your Loans</h3>
    </div>
    <div id="loans-container" class="p-6">
     <div id="empty-state" class="text-center py-12">
      <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
       <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
       </svg>
      </div>
      <h4 class="text-lg font-medium text-gray-900 mb-2">No loans yet</h4>
      <p class="text-gray-600 mb-6">Get started by adding your first loan to track payments and balances.</p><button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200"> Add Your First Loan </button>
     </div>
     <div id="loans-list" class="space-y-4 hidden"></div>
    </div>
   </div>
   
   <!-- Add Loan Modal -->
   <div id="add-loan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
     <div class="p-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-xl font-bold text-gray-900">Add New Loan</h3><button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg></button>
      </div>

      <!--Add loan form-->
      <form id="add-loan-form" class="space-y-4">
       <div><label for="loan-type" class="block text-sm font-medium text-gray-700 mb-2">Loan Type</label> <select id="loan-type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"> <option value="">Select loan type</option> <option value="Personal">Personal Loan</option> <option value="Auto">Auto Loan</option> <option value="Mortgage">Mortgage</option> <option value="Student">Student Loan</option> <option value="Business">Business Loan</option> <option value="Credit Card">Credit Card</option> </select>
       </div>
       <div><label for="loan-amount" class="block text-sm font-medium text-gray-700 mb-2">Loan Amount (Ksh)</label> <input id="loan-amount" type="number" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="25000">
       </div>
       <div><label for="interest-rate" class="block text-sm font-medium text-gray-700 mb-2">Interest Rate (%)</label> <input id="interest-rate" type="number" step="0.01" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="5.5">
       </div>
       <div><label for="term-months" class="block text-sm font-medium text-gray-700 mb-2">Term (Months)</label> <input id="term-months" type="number" min="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="60">
       </div>
       <div><label for="next-payment-date" class="block text-sm font-medium text-gray-700 mb-2">Next Payment Date</label> <input id="next-payment-date" type="date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
       </div>
       <div class="flex space-x-3 pt-4"><button type="button" id="cancel-btn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-colors duration-200"> Cancel </button> <button type="submit" id="save-loan-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200"> Add Loan </button>
       </div>
      </form>
     </div>
    </div>
   </div>
   
   <!-- Loading State -->
   <div id="loading-state" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40">
    <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
     <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><span class="text-gray-700">Processing...</span>
    </div>
   </div>
   
   <!-- Limit Warning -->
   <div id="limit-warning" class="fixed top-4 right-4 bg-red-50 border border-red-200 rounded-lg p-4 shadow-lg hidden z-30">
    <div class="flex items-center">
     <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
     </svg>
     <div>
      <p class="font-medium text-red-800">Limit Reached</p>
      <p class="text-sm text-red-600">Maximum of 10 loans allowed. Please delete some loans first.</p>
     </div>
    </div>
   </div>
  </main>
  <script>
        // Initialize Element SDK
        const defaultConfig = {
            company_name: "LoanPro",
            welcome_message: "Welcome to your loan management dashboard"
        };

        async function onConfigChange(config) {
            const companyNameEl = document.getElementById('company-name');
            const welcomeMessageEl = document.getElementById('welcome-message');
            
            if (companyNameEl) {
                companyNameEl.textContent = config.company_name || defaultConfig.company_name;
            }
            if (welcomeMessageEl) {
                welcomeMessageEl.textContent = config.welcome_message || defaultConfig.welcome_message;
            }
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["company_name", config.company_name || defaultConfig.company_name],
                ["welcome_message", config.welcome_message || defaultConfig.welcome_message]
            ]);
        }

        // Initialize Element SDK when available
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities,
                mapToEditPanelValues
            });
        }

        // Global variables
        let currentLoans = [];
        let isLoading = false;
        let sdkInitialized = false;

        // Data SDK handler
        const dataHandler = {
            onDataChanged(data) {
                currentLoans = data;
                updateDashboard();
                renderLoansList();
            }
        };

        // Initialize Data SDK
        async function initializeDataSDK() {
            if (window.dataSdk) {
                try {
                    const result = await window.dataSdk.init(dataHandler);
                    if (result.isOk) {
                        sdkInitialized = true;
                        console.log("Data SDK initialized successfully");
                    } else {
                        console.error("Failed to initialize Data SDK:", result.error);
                        showInlineError("Failed to initialize data service. Please refresh the page.");
                    }
                } catch (error) {
                    console.error("Error initializing Data SDK:", error);
                    showInlineError("Data service error. Please refresh the page.");
                }
            } else {
                console.error("Data SDK not available");
                showInlineError("Data service not available. Please refresh the page.");
            }
        }

        // Calculate monthly payment using loan formula
        function calculateMonthlyPayment(principal, annualRate, termMonths) {
            if (annualRate === 0) return principal / termMonths;
            
            const monthlyRate = annualRate / 100 / 12;
            const payment = principal * (monthlyRate * Math.pow(1 + monthlyRate, termMonths)) / 
                           (Math.pow(1 + monthlyRate, termMonths) - 1);
            return payment;
        }

        // Update dashboard statistics
        function updateDashboard() {
            const totalLoans = currentLoans.length;
            const activeLoans = currentLoans.filter(loan => loan.status === 'Active').length;
            const totalBalance = currentLoans.reduce((sum, loan) => sum + (loan.balance_remaining || 0), 0);
            const monthlyPayment = currentLoans.reduce((sum, loan) => sum + (loan.monthly_payment || 0), 0);

            document.getElementById('total-loans').textContent = totalLoans;
            document.getElementById('active-loans').textContent = activeLoans;
            document.getElementById('total-balance').textContent = `$${totalBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('monthly-payment').textContent = `$${monthlyPayment.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // Render loans list
        function renderLoansList() {
            const emptyState = document.getElementById('empty-state');
            const loansList = document.getElementById('loans-list');

            if (currentLoans.length === 0) {
                emptyState.classList.remove('hidden');
                loansList.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            loansList.classList.remove('hidden');

            loansList.innerHTML = currentLoans.map(loan => `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200" data-loan-id="${loan.__backendId}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-semibold text-gray-900">${loan.loan_type} Loan</h4>
                            <p class="text-sm text-gray-600">Next payment: ${new Date(loan.next_payment_date).toLocaleDateString()}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${loan.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${loan.status}
                            </span>
                            <button class="delete-loan-btn text-red-600 hover:text-red-700 p-1" data-loan-id="${loan.__backendId}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <p class="text-gray-600">Balance</p>
                            <p class="font-semibold">$${loan.balance_remaining.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Monthly Payment</p>
                            <p class="font-semibold">$${loan.monthly_payment.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Interest Rate</p>
                            <p class="font-semibold">${loan.interest_rate}%</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Term</p>
                            <p class="font-semibold">${loan.term_months} months</p>
                        </div>
                    </div>
                </div>
            `).join('');

            // Add delete event listeners
            document.querySelectorAll('.delete-loan-btn').forEach(btn => {
                btn.addEventListener('click', handleDeleteLoan);
            });
        }

        // Show loading state
        function showLoading() {
            isLoading = true;
            document.getElementById('loading-state').classList.remove('hidden');
            const saveBtn = document.getElementById('save-loan-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Adding...';
        }

        // Hide loading state
        function hideLoading() {
            isLoading = false;
            document.getElementById('loading-state').classList.add('hidden');
            const saveBtn = document.getElementById('save-loan-btn');
            saveBtn.disabled = false;
            saveBtn.textContent = 'Add Loan';
        }

        // Show limit warning
        function showLimitWarning() {
            const warning = document.getElementById('limit-warning');
            warning.classList.remove('hidden');
            setTimeout(() => {
                warning.classList.add('hidden');
            }, 5000);
        }

        // Handle add loan
        async function handleAddLoan(e) {
            e.preventDefault();
            
            if (isLoading) return;

            // Check if SDK is initialized
            if (!sdkInitialized) {
                showInlineError('Data service not ready. Please wait a moment and try again.');
                return;
            }

            // Check limit before creating
            if (currentLoans.length >= 999) {
                showLimitWarning();
                return;
            }

            showLoading();

            try {
                const loanType = document.getElementById('loan-type').value;
                const amount = parseFloat(document.getElementById('loan-amount').value);
                const interestRate = parseFloat(document.getElementById('interest-rate').value);
                const termMonths = parseInt(document.getElementById('term-months').value);
                const nextPaymentDate = document.getElementById('next-payment-date').value;

                const monthlyPayment = calculateMonthlyPayment(amount, interestRate, termMonths);

                const newLoan = {
                    id: Date.now().toString(),
                    loan_type: loanType,
                    amount: amount,
                    interest_rate: interestRate,
                    term_months: termMonths,
                    monthly_payment: monthlyPayment,
                    balance_remaining: amount,
                    next_payment_date: nextPaymentDate,
                    status: 'Active',
                    created_at: new Date().toISOString()
                };

                const result = await window.dataSdk.create(newLoan);
                
                hideLoading();
                
                if (result.isOk) {
                    // Close modal and reset form
                    document.getElementById('add-loan-modal').classList.add('hidden');
                    document.getElementById('add-loan-form').reset();
                    
                    // Reset next payment date to next month
                    const nextMonth = new Date();
                    nextMonth.setMonth(nextMonth.getMonth() + 1);
                    document.getElementById('next-payment-date').value = nextMonth.toISOString().split('T')[0];
                    
                    showSuccessMessage('Loan added successfully!');
                } else {
                    showInlineError('Failed to add loan. Please try again.');
                }
            } catch (error) {
                hideLoading();
                console.error('Error adding loan:', error);
                showInlineError('An error occurred while adding the loan. Please try again.');
            }
        }

        // Handle delete loan
        async function handleDeleteLoan(e) {
            const loanId = e.currentTarget.dataset.loanId;
            const loan = currentLoans.find(l => l.__backendId === loanId);
            
            if (!loan) return;

            // Show inline confirmation
            const deleteBtn = e.currentTarget;
            
            // Replace delete button with confirmation
            deleteBtn.innerHTML = `
                <div class="flex items-center space-x-2">
                    <button class="confirm-delete-btn bg-red-600 hover:bg-red-700 text-white text-xs px-2 py-1 rounded" data-loan-id="${loanId}">
                        Confirm
                    </button>
                    <button class="cancel-delete-btn bg-gray-300 hover:bg-gray-400 text-gray-700 text-xs px-2 py-1 rounded">
                        Cancel
                    </button>
                </div>
            `;

            // Add event listeners for confirmation buttons
            const confirmBtn = deleteBtn.querySelector('.confirm-delete-btn');
            const cancelBtn = deleteBtn.querySelector('.cancel-delete-btn');

            confirmBtn.addEventListener('click', async () => {
                try {
                    const result = await window.dataSdk.delete(loan);
                    if (result.isOk) {
                        showSuccessMessage('Loan deleted successfully!');
                    } else {
                        showInlineError('Failed to delete loan. Please try again.');
                        restoreDeleteButton(deleteBtn);
                    }
                } catch (error) {
                    console.error('Error deleting loan:', error);
                    showInlineError('An error occurred while deleting the loan. Please try again.');
                    restoreDeleteButton(deleteBtn);
                }
            });

            cancelBtn.addEventListener('click', () => {
                restoreDeleteButton(deleteBtn);
            });
        }

        // Restore original delete button
        function restoreDeleteButton(deleteBtn) {
            deleteBtn.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
            `;
        }

        // Show success message
        function showSuccessMessage(message) {
            const successEl = document.createElement('div');
            successEl.className = 'fixed top-4 right-4 bg-green-50 border border-green-200 rounded-lg p-4 shadow-lg z-30';
            successEl.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-green-800">${message}</p>
                </div>
            `;
            document.body.appendChild(successEl);
            
            setTimeout(() => {
                successEl.remove();
            }, 3000);
        }

        // Show inline error message
        function showInlineError(message) {
            const errorEl = document.createElement('div');
            errorEl.className = 'fixed top-4 right-4 bg-red-50 border border-red-200 rounded-lg p-4 shadow-lg z-30';
            errorEl.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-red-800">${message}</p>
                </div>
            `;
            document.body.appendChild(errorEl);
            
            setTimeout(() => {
                errorEl.remove();
            }, 5000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const user = localStorage.getItem('loanpro_user');
            if (!user) {
                window.location.href = 'auth.html';
                return;
            }

            // Display user name
            const userData = JSON.parse(user);
            document.getElementById('user-name').textContent = `Welcome, ${userData.name}!`;

            // Set default next payment date to next month
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            document.getElementById('next-payment-date').value = nextMonth.toISOString().split('T')[0];

            // Initialize Data SDK
            initializeDataSDK();

            // Modal controls
            const addLoanBtn = document.getElementById('add-loan-btn');
            const modal = document.getElementById('add-loan-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const addLoanForm = document.getElementById('add-loan-form');

            addLoanBtn.addEventListener('click', () => {
                if (currentLoans.length >= 999) {
                    showLimitWarning();
                    return;
                }
                modal.classList.remove('hidden');
            });

            closeModalBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            cancelBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });

            // Form submission
            addLoanForm.addEventListener('submit', handleAddLoan);

            // Empty state button
            document.querySelector('#empty-state button').addEventListener('click', () => {
                if (currentLoans.length >= 999) {
                    showLimitWarning();
                    return;
                }
                modal.classList.remove('hidden');
            });

            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('loanpro_user');
                window.location.href = 'auth.html';
            });
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99f70d2340b43eab',t:'MTc2MzI5Njc2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>